# 最大魚長検索

## 📖 問題文（日本語訳）

釣りアプリで使用する `FISH_INFO` テーブルには、捕獲した魚の情報が格納されています。

このテーブルから、捕獲した魚の中で最も大きい魚の長さを検索し、'cm' を付けて出力するSQL文を作成してください。

**条件**：
- カラム名は `MAX_LENGTH` と指定すること
- 捕獲した魚の長さが10cm以下の場合、LENGTH は NULL
- LENGTH に NULL のみが含まれることはない

## 📊 テーブル構造

### FISH_INFO テーブル

| Column name | Type    | Nullable | 説明                     |
|-------------|---------|----------|--------------------------|
| ID          | INTEGER | FALSE    | 捕獲した魚のID           |
| FISH_TYPE   | INTEGER | FALSE    | 魚の種類（数値）         |
| LENGTH      | FLOAT   | TRUE     | 捕獲した魚の長さ（cm）   |
| TIME        | DATE    | FALSE    | 魚を捕獲した日付         |

**注意事項**：
- 捕獲した魚の長さが10cm以下の場合、LENGTH は NULL
- LENGTH に NULL のみが含まれることはない

### サンプルデータ

| ID | FISH_TYPE | LENGTH | TIME       |
|----|-----------|--------|------------|
| 0  | 0         | 13.37  | 2021-12-04 |
| 1  | 0         | 50.00  | 2020-03-07 |
| 2  | 0         | 40.00  | 2020-03-07 |
| 3  | 1         | 43.33  | 2022-03-09 |
| 4  | 1         | NULL   | 2022-04-08 |
| 5  | 2         | 32.00  | 2020-04-28 |

## 🎯 期待される出力

| MAX_LENGTH |
|------------|
| 50.00cm    |

**説明**：
- 最も大きい魚の長さは50.00cmなので、`50.00cm` が出力される
- NULL値（ID=4）は自動的に除外される

## 💡 解答

### 最適化されたSQL

```sql
SELECT CONCAT(MAX(LENGTH), 'cm') AS MAX_LENGTH
FROM FISH_INFO;
```

## 📝 解説

### 解法のポイント

1. **MAX()集計関数**
   - `MAX(LENGTH)`：LENGTH列の最大値を取得
   - NULL値は自動的に除外されるため、WHERE句でのNULL除外は不要

2. **CONCAT()文字列結合**
   - `CONCAT(MAX(LENGTH), 'cm')`：最大値に'cm'を連結
   - 数値と文字列を結合して指定フォーマットで出力

3. **カラムエイリアス**
   - `AS MAX_LENGTH`：結果のカラム名を指定

### パフォーマンスチューニング

#### インデックス戦略

**推奨インデックス**：
```sql
CREATE INDEX idx_fish_length ON FISH_INFO(LENGTH DESC);
```

**理由**：
- 降順インデックスにより、MAX()の検索が最適化される
- インデックスの先頭が最大値なので、フルテーブルスキャン不要
- 特に大量データの場合、劇的なパフォーマンス向上

#### 実行計画の確認

```sql
EXPLAIN SELECT CONCAT(MAX(LENGTH), 'cm') AS MAX_LENGTH
FROM FISH_INFO;
```

**期待される実行計画**：
- インデックスがある場合：`Using index` が表示される
- インデックスがない場合：`Using filesort` またはフルテーブルスキャン

#### パフォーマンス比較

**インデックスなし**：
- すべての行をスキャンして最大値を検索
- 時間計算量：O(n)

**降順インデックスあり**：
- インデックスの先頭要素（最大値）を直接取得
- 時間計算量：O(1)

### 代替アプローチ

#### オプション1：明示的NULL除外（冗長）

```sql
SELECT CONCAT(MAX(LENGTH), 'cm') AS MAX_LENGTH
FROM FISH_INFO
WHERE LENGTH IS NOT NULL;
```

**評価**：
- MAX()は自動的にNULLを除外するため、WHERE句は不要
- クエリオプティマイザに余分な条件を与える可能性
- 推奨しない

#### オプション2：ORDER BY + LIMIT（非効率）

```sql
SELECT CONCAT(LENGTH, 'cm') AS MAX_LENGTH
FROM FISH_INFO
WHERE LENGTH IS NOT NULL
ORDER BY LENGTH DESC
LIMIT 1;
```

**評価**：
- すべての行をソートする必要がある
- MAX()より非効率
- インデックスがあっても、集計関数より遅い
- 推奨しない

#### オプション3：数値フォーマット制御

```sql
SELECT CONCAT(FORMAT(MAX(LENGTH), 2), 'cm') AS MAX_LENGTH
FROM FISH_INFO;
```

**評価**：
- FORMAT()で小数点桁数を明示的に制御
- サンプルデータでは必要ないが、データ精度が不統一な場合に有用

### 集計関数とNULL値の関係

| 集計関数 | NULL値の扱い |
|---------|-------------|
| MAX()   | 自動除外     |
| MIN()   | 自動除外     |
| AVG()   | 自動除外     |
| SUM()   | 自動除外     |
| COUNT(*) | カウントに含める |
| COUNT(column) | 自動除外 |

**重要**：すべての標準集計関数はNULL値を自動的に除外します。

## 🔑 キーワード

- `MAX()`：最大値を求める集計関数
- `CONCAT()`：文字列を結合する関数
- **NULL値の自動除外**：集計関数はNULLを無視
- **降順インデックス**：MAX/MIN最適化の鍵
- **集計関数の最適化**：インデックス活用でO(1)検索
- **文字列フォーマット**：数値と文字列の連結

## 🎓 学習ポイント

1. MAX()集計関数はNULL値を自動的に除外する
2. 降順インデックスでMAX()のパフォーマンスを劇的に改善できる
3. CONCAT()で数値と文字列を簡単に連結できる
4. 明示的なWHERE LENGTH IS NOT NULLは冗長で不要
5. ORDER BY + LIMITよりMAX()の方が効率的
6. インデックスの方向（昇順/降順）が最適化に影響する

## 💡 応用例

### 複数の集計を同時に取得

```sql
SELECT
    CONCAT(MAX(LENGTH), 'cm') AS MAX_LENGTH,
    CONCAT(MIN(LENGTH), 'cm') AS MIN_LENGTH,
    CONCAT(ROUND(AVG(LENGTH), 2), 'cm') AS AVG_LENGTH
FROM FISH_INFO;
```

### 魚種別の最大長

```sql
SELECT
    FISH_TYPE,
    CONCAT(MAX(LENGTH), 'cm') AS MAX_LENGTH
FROM FISH_INFO
GROUP BY FISH_TYPE
ORDER BY MAX(LENGTH) DESC;
```

### 最大長の魚の詳細情報

```sql
SELECT *
FROM FISH_INFO
WHERE LENGTH = (SELECT MAX(LENGTH) FROM FISH_INFO);
```

---

**作成日**: 2025-10-08
**難易度**: ⭐ 基本
**カテゴリ**: AGGREGATE, MAX, CONCAT, インデックス最適化
