# 3月生まれの女性会員検索

## 📖 問題文（日本語訳）

食堂レビューサイトの会員情報を管理する `MEMBER_PROFILE` テーブルがあります。

このテーブルから、以下の条件を満たす会員情報を検索してください：

- 生年月日が3月の女性会員
- 電話番号が NULL でない会員
- 結果は会員IDを基準に昇順でソート

出力カラム：会員ID、会員名、性別、生年月日

## 📊 テーブル構造

### MEMBER_PROFILE テーブル

| Column name    | Type         | Nullable | 説明           |
|----------------|--------------|----------|----------------|
| MEMBER_ID      | VARCHAR(100) | FALSE    | 会員ID         |
| MEMBER_NAME    | VARCHAR(50)  | FALSE    | 会員名         |
| TLNO           | VARCHAR(50)  | TRUE     | 電話番号       |
| GENDER         | VARCHAR(1)   | TRUE     | 性別（W/M）    |
| DATE_OF_BIRTH  | DATE         | TRUE     | 生年月日       |

### サンプルデータ

| MEMBER_ID              | MEMBER_NAME | TLNO        | GENDER | DATE_OF_BIRTH |
|------------------------|-------------|-------------|--------|---------------|
| jiho92@naver.com       | イ・ジホ   | 01076432111 | W      | 1992-02-12    |
| jiyoon22@hotmail.com   | キム・ジユン | 01032324117 | W      | 1992-02-22    |
| jihoon93@hanmail.net   | キム・ジフン | 01023258688 | M      | 1993-02-23    |
| seoyeons@naver.com     | パク・ソヨン | 01076482209 | W      | 1993-03-16    |
| yoonsy94@gmail.com     | ユン・ソヨン | NULL        | W      | 1994-03-19    |

## 🎯 期待される出力

| MEMBER_ID          | MEMBER_NAME | GENDER | DATE_OF_BIRTH |
|--------------------|-------------|--------|---------------|
| seoyeons@naver.com | パク・ソヨン | W      | 1993-03-16    |

**注意事項**：
- DATE_OF_BIRTH のフォーマットは `'%Y-%m-%d'` 形式で出力すること
- 電話番号が NULL の `yoonsy94@gmail.com` は除外される

## 💡 解答

### 最適化されたSQL

```sql
SELECT
    MEMBER_ID,
    MEMBER_NAME,
    GENDER,
    DATE_FORMAT(DATE_OF_BIRTH, '%Y-%m-%d') AS DATE_OF_BIRTH
FROM MEMBER_PROFILE
WHERE GENDER = 'W'
  AND TLNO IS NOT NULL
  AND MONTH(DATE_OF_BIRTH) = 3
ORDER BY MEMBER_ID;
```

## 📝 解説

### 解法のポイント

1. **WHERE句の条件順序**
   - `GENDER = 'W'`：カーディナリティが低く、インデックスが効きやすい条件を先に配置
   - `TLNO IS NOT NULL`：NULL値を早期に除外
   - `MONTH(DATE_OF_BIRTH) = 3`：関数を使用する条件は最後に評価

2. **日付フォーマット**
   - `DATE_FORMAT(DATE_OF_BIRTH, '%Y-%m-%d')`で要求されたフォーマットに変換
   - SELECT句で変換することでWHERE句のパフォーマンスに影響なし

3. **月の抽出**
   - `MONTH(DATE_OF_BIRTH) = 3`：シンプルで可読性が高い
   - 年に関係なく3月のみを抽出

### パフォーマンスチューニング

#### インデックス戦略

**推奨インデックス**：
```sql
CREATE INDEX idx_member_profile_gender_birth
ON MEMBER_PROFILE(GENDER, DATE_OF_BIRTH);
```

または、電話番号も含める：
```sql
CREATE INDEX idx_member_profile_gender_tlno_birth
ON MEMBER_PROFILE(GENDER, TLNO, DATE_OF_BIRTH);
```

**理由**：
- `GENDER`を先頭にすることで、WHERE句の最初の条件で絞り込み可能
- `DATE_OF_BIRTH`を含めることで、カバリングインデックスの効果

#### 関数インデックスの活用（MySQL 8.0+）

大量データの場合、生成列を使用してインデックスを作成：

```sql
-- 生成列を追加
ALTER TABLE MEMBER_PROFILE
ADD COLUMN birth_month TINYINT GENERATED ALWAYS AS (MONTH(DATE_OF_BIRTH)) STORED;

-- 生成列にインデックスを作成
CREATE INDEX idx_member_birth_month ON MEMBER_PROFILE(GENDER, birth_month);

-- クエリを変更
SELECT
    MEMBER_ID,
    MEMBER_NAME,
    GENDER,
    DATE_FORMAT(DATE_OF_BIRTH, '%Y-%m-%d') AS DATE_OF_BIRTH
FROM MEMBER_PROFILE
WHERE GENDER = 'W'
  AND TLNO IS NOT NULL
  AND birth_month = 3
ORDER BY MEMBER_ID;
```

#### クエリ実行計画の確認

```sql
EXPLAIN SELECT
    MEMBER_ID,
    MEMBER_NAME,
    GENDER,
    DATE_FORMAT(DATE_OF_BIRTH, '%Y-%m-%d') AS DATE_OF_BIRTH
FROM MEMBER_PROFILE
WHERE GENDER = 'W'
  AND TLNO IS NOT NULL
  AND MONTH(DATE_OF_BIRTH) = 3
ORDER BY MEMBER_ID;
```

**チェックポイント**：
- `type`: `ref` または `range` であることを確認
- `key`: インデックスが使用されていることを確認
- `rows`: スキャンされる行数が少ないことを確認

### 代替アプローチ

#### オプション1：LIKE演算子を使用

```sql
SELECT
    MEMBER_ID,
    MEMBER_NAME,
    GENDER,
    DATE_FORMAT(DATE_OF_BIRTH, '%Y-%m-%d') AS DATE_OF_BIRTH
FROM MEMBER_PROFILE
WHERE GENDER = 'W'
  AND TLNO IS NOT NULL
  AND DATE_OF_BIRTH LIKE '%-03-%'
ORDER BY MEMBER_ID;
```

**注意**：パターンマッチングはフルテーブルスキャンの可能性が高い

#### オプション2：BETWEEN演算子を使用

年を問わず3月のみを抽出する場合、複雑になるため推奨しない。

## 🔑 キーワード

- `SELECT`：基本的なデータ検索
- `WHERE`：複数条件の組み合わせ
- `MONTH()`：日付から月を抽出する関数
- `DATE_FORMAT()`：日付フォーマット変換
- `IS NOT NULL`：NULL値の除外
- `ORDER BY`：結果のソート
- **インデックス設計**：複合インデックスの効果的な活用
- **パフォーマンスチューニング**：条件順序の最適化
- **生成列**：関数インデックスの代替手法

## 🎓 学習ポイント

1. WHERE句の条件順序がパフォーマンスに影響する
2. 関数を使用した条件はインデックスが効きにくい
3. DATE_FORMAT()はSELECT句で使用し、WHERE句では避ける
4. 適切なインデックス設計でクエリパフォーマンスを大幅に改善できる
5. EXPLAIN文でクエリ実行計画を確認する習慣が重要

---

**作成日**: 2025-10-08
**難易度**: ⭐ 基本
**カテゴリ**: SELECT, WHERE, 日付関数, インデックス最適化
