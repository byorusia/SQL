# 中古取引掲示板特定日検索

## 📖 問題文（日本語訳）

中古取引掲示板の情報を管理する `USED_GOODS_BOARD` テーブルがあります。

このテーブルから、2022年10月5日に登録された中古取引投稿を検索してください。

**条件**：
- 出力カラム：BOARD_ID（投稿ID）、WRITER_ID（作成者ID）、TITLE（タイトル）、PRICE（価格）、STATUS（取引状態）
- STATUSの変換：
  - SALE → 販売中
  - RESERVED → 予約中
  - DONE → 取引完了
- 結果は投稿IDを基準に降順でソート

## 📊 テーブル構造

### USED_GOODS_BOARD テーブル

| Column name  | Type         | Nullable | 説明           |
|--------------|--------------|----------|----------------|
| BOARD_ID     | VARCHAR(5)   | FALSE    | 投稿ID         |
| WRITER_ID    | VARCHAR(50)  | FALSE    | 作成者ID       |
| TITLE        | VARCHAR(100) | FALSE    | 投稿タイトル   |
| CONTENTS     | VARCHAR(1000)| FALSE    | 投稿内容       |
| PRICE        | NUMBER       | FALSE    | 価格           |
| CREATED_DATE | DATE         | FALSE    | 作成日         |
| STATUS       | VARCHAR(10)  | FALSE    | 取引状態       |
| VIEWS        | NUMBER       | FALSE    | 閲覧数         |

**STATUS値**：
- `SALE`：販売中
- `RESERVED`：予約中
- `DONE`：取引完了

### サンプルデータ

| BOARD_ID | WRITER_ID  | TITLE              | CONTENTS                                | PRICE | CREATED_DATE | STATUS   | VIEWS |
|----------|------------|--------------------|-----------------------------------------|-------|--------------|----------|-------|
| B0007    | s2s2123    | コーヒーグラインダー | 新品同様にきれいです。                  | 7000  | 2022-10-04   | DONE     | 210   |
| B0008    | hong02     | 自転車販売します    | 通勤用に購入しましたが使わないので出品  | 40000 | 2022-10-04   | SALE     | 301   |
| B0009    | yawoong67  | 棚売ります          | 6段棚。返金返品不可。                   | 12000 | 2022-10-05   | DONE     | 202   |
| B0010    | keel1990   | 鉄製棚5段           | 鉄製棚5段組み立て式                     | 10000 | 2022-10-05   | SALE     | 194   |

## 🎯 期待される出力

| BOARD_ID | WRITER_ID  | TITLE      | PRICE | STATUS     |
|----------|------------|------------|-------|------------|
| B0010    | keel1990   | 鉄製棚5段  | 10000 | 販売中     |
| B0009    | yawoong67  | 棚売ります | 12000 | 取引完了   |

**説明**：
- 2022-10-05の投稿のみ抽出（B0009、B0010）
- BOARD_ID降順でソート（B0010 → B0009）
- STATUSを日本語に変換

## 💡 解答

### 最適化されたSQL

```sql
SELECT
    BOARD_ID,
    WRITER_ID,
    TITLE,
    PRICE,
    CASE STATUS
        WHEN 'SALE' THEN '販売中'
        WHEN 'RESERVED' THEN '予約中'
        WHEN 'DONE' THEN '取引完了'
    END AS STATUS
FROM USED_GOODS_BOARD
WHERE CREATED_DATE = '2022-10-05'
ORDER BY BOARD_ID DESC;
```

## 📝 解説

### 解法のポイント

1. **日付の等価検索**
   ```sql
   WHERE CREATED_DATE = '2022-10-05'
   ```
   - DATE型なので文字列で直接比較
   - 関数を使わないためインデックスが効く
   - 時刻情報がない場合は等価比較が最適

2. **CASE式によるステータス変換**
   ```sql
   CASE STATUS
       WHEN 'SALE' THEN '販売中'
       WHEN 'RESERVED' THEN '予約中'
       WHEN 'DONE' THEN '取引完了'
   END AS STATUS
   ```
   - **簡易CASE式**：`CASE column WHEN value THEN result`
   - STATUSカラムの値で分岐
   - 元のカラム名と同じエイリアスを使用（上書き）

3. **降順ソート**
   ```sql
   ORDER BY BOARD_ID DESC
   ```
   - `DESC`：降順（Descending）
   - デフォルトは`ASC`（昇順：Ascending）

### CASE式の2つの構文

#### 簡易CASE式（Simple CASE）

```sql
CASE column_name
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    ELSE default_result
END
```

**特徴**：
- カラムの値で分岐
- 等価比較のみ
- シンプルで可読性が高い

**使用例**：
```sql
CASE STATUS
    WHEN 'SALE' THEN '販売中'
    WHEN 'RESERVED' THEN '予約中'
    WHEN 'DONE' THEN '取引完了'
END
```

#### 検索CASE式（Searched CASE）

```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ELSE default_result
END
```

**特徴**：
- 任意の条件式で分岐
- 比較演算子、範囲検索などが可能
- より柔軟だが複雑

**使用例**：
```sql
CASE
    WHEN PRICE >= 50000 THEN '高額'
    WHEN PRICE >= 10000 THEN '中額'
    ELSE '低額'
END
```

**今回の問題では簡易CASE式が最適**：
- STATUS列の値で分岐
- 等価比較のみ
- シンプルで理解しやすい

### パフォーマンスチューニング

#### インデックス戦略

**推奨インデックス**：
```sql
CREATE INDEX idx_board_created ON USED_GOODS_BOARD(CREATED_DATE);
```

**理由**：
- WHERE句でCREATED_DATEを使用
- 等価検索なので効率的にヒット
- 関数を使わないためインデックスが効く

#### 複合インデックス（さらに最適化）

```sql
CREATE INDEX idx_board_created_id ON USED_GOODS_BOARD(CREATED_DATE, BOARD_ID DESC);
```

**効果**：
- WHERE句のCREATED_DATEとORDER BYのBOARD_IDを両方カバー
- ソート操作を削減
- カバリングインデックスとして機能

**インデックスの方向**：
- `BOARD_ID DESC`：降順インデックス
- ORDER BY DESCと一致するため効率的

#### カバリングインデックス（最大限の最適化）

```sql
CREATE INDEX idx_board_covering
ON USED_GOODS_BOARD(CREATED_DATE, BOARD_ID DESC, WRITER_ID, TITLE, PRICE, STATUS);
```

**効果**：
- すべての必要カラムを含む
- テーブルアクセス不要（インデックスのみで完結）
- 最速だがストレージコストが高い

**トレードオフ**：
- **メリット**：クエリ速度が最速
- **デメリット**：インデックスサイズ大、INSERT/UPDATE時のコスト増

#### 実行計画の確認

```sql
EXPLAIN SELECT
    BOARD_ID,
    WRITER_ID,
    TITLE,
    PRICE,
    CASE STATUS
        WHEN 'SALE' THEN '販売中'
        WHEN 'RESERVED' THEN '予約中'
        WHEN 'DONE' THEN '取引完了'
    END AS STATUS
FROM USED_GOODS_BOARD
WHERE CREATED_DATE = '2022-10-05'
ORDER BY BOARD_ID DESC;
```

**チェックポイント**：
- `type`: `ref`（インデックス使用）
- `key`: `idx_board_created`（インデックス名）
- `Extra`: `Using index`（カバリングインデックス）
- `rows`: スキャン行数が少ないことを確認

### 代替アプローチ

#### オプション1：検索CASE式を使用

```sql
SELECT
    BOARD_ID,
    WRITER_ID,
    TITLE,
    PRICE,
    CASE
        WHEN STATUS = 'SALE' THEN '販売中'
        WHEN STATUS = 'RESERVED' THEN '予約中'
        WHEN STATUS = 'DONE' THEN '取引完了'
    END AS STATUS
FROM USED_GOODS_BOARD
WHERE CREATED_DATE = '2022-10-05'
ORDER BY BOARD_ID DESC;
```

**評価**：
- 結果は同じ
- やや冗長
- 簡易CASE式の方が簡潔

#### オプション2：日付関数を使用（非推奨）

```sql
SELECT
    BOARD_ID,
    WRITER_ID,
    TITLE,
    PRICE,
    CASE STATUS
        WHEN 'SALE' THEN '販売中'
        WHEN 'RESERVED' THEN '予約中'
        WHEN 'DONE' THEN '取引完了'
    END AS STATUS
FROM USED_GOODS_BOARD
WHERE DATE(CREATED_DATE) = '2022-10-05'
ORDER BY BOARD_ID DESC;
```

**評価**：
- DATE()関数を使用
- インデックスが効かない
- パフォーマンス低下
- **推奨しない**

#### オプション3：範囲検索

```sql
SELECT
    BOARD_ID,
    WRITER_ID,
    TITLE,
    PRICE,
    CASE STATUS
        WHEN 'SALE' THEN '販売中'
        WHEN 'RESERVED' THEN '予約中'
        WHEN 'DONE' THEN '取引完了'
    END AS STATUS
FROM USED_GOODS_BOARD
WHERE CREATED_DATE >= '2022-10-05' AND CREATED_DATE < '2022-10-06'
ORDER BY BOARD_ID DESC;
```

**評価**：
- 日時情報がある場合に有効
- インデックスが効く
- DATE型で時刻情報がない場合は冗長

#### オプション4：ELSEを追加（安全策）

```sql
SELECT
    BOARD_ID,
    WRITER_ID,
    TITLE,
    PRICE,
    CASE STATUS
        WHEN 'SALE' THEN '販売中'
        WHEN 'RESERVED' THEN '予約中'
        WHEN 'DONE' THEN '取引完了'
        ELSE '不明'
    END AS STATUS
FROM USED_GOODS_BOARD
WHERE CREATED_DATE = '2022-10-05'
ORDER BY BOARD_ID DESC;
```

**評価**：
- 予期しない値への対応
- データ品質が保証されていない場合に有用
- オプショナルだが推奨

## 🔑 キーワード

- **簡易CASE式**：`CASE column WHEN value THEN result`
- **検索CASE式**：`CASE WHEN condition THEN result`
- `ORDER BY DESC`：降順ソート
- **日付等価検索**：関数を使わずインデックス活用
- **ステータスコード変換**：コード値を表示用テキストに変換
- **複合インデックス**：WHERE句とORDER BY両方をカバー
- **降順インデックス**：`CREATE INDEX ... (column DESC)`

## 🎓 学習ポイント

1. 簡易CASE式は等価比較のみでシンプル
2. 検索CASE式は任意の条件式で柔軟
3. ステータスコード変換は実務で頻出パターン
4. 日付検索は関数を避けてインデックスを活用
5. ORDER BY DESCで降順ソート
6. 複合インデックスでWHERE句とORDER BY両方を最適化
7. カバリングインデックスは最速だがコストとのトレードオフ

## 💡 応用例

### 価格帯別のステータス集計

```sql
SELECT
    CASE
        WHEN PRICE >= 50000 THEN '高額'
        WHEN PRICE >= 10000 THEN '中額'
        ELSE '低額'
    END AS PRICE_RANGE,
    CASE STATUS
        WHEN 'SALE' THEN '販売中'
        WHEN 'RESERVED' THEN '予約中'
        WHEN 'DONE' THEN '取引完了'
    END AS STATUS,
    COUNT(*) AS COUNT
FROM USED_GOODS_BOARD
WHERE CREATED_DATE = '2022-10-05'
GROUP BY PRICE_RANGE, STATUS
ORDER BY PRICE_RANGE, STATUS;
```

### 月別のステータス別件数

```sql
SELECT
    DATE_FORMAT(CREATED_DATE, '%Y-%m') AS MONTH,
    CASE STATUS
        WHEN 'SALE' THEN '販売中'
        WHEN 'RESERVED' THEN '予約中'
        WHEN 'DONE' THEN '取引完了'
    END AS STATUS,
    COUNT(*) AS COUNT
FROM USED_GOODS_BOARD
GROUP BY MONTH, STATUS
ORDER BY MONTH DESC, STATUS;
```

### 閲覧数ランク付け

```sql
SELECT
    BOARD_ID,
    TITLE,
    VIEWS,
    CASE
        WHEN VIEWS >= 500 THEN '★★★ 大人気'
        WHEN VIEWS >= 200 THEN '★★ 人気'
        WHEN VIEWS >= 100 THEN '★ 普通'
        ELSE '新規'
    END AS POPULARITY
FROM USED_GOODS_BOARD
WHERE CREATED_DATE = '2022-10-05'
ORDER BY VIEWS DESC;
```

### ステータス遷移の追跡

```sql
SELECT
    BOARD_ID,
    TITLE,
    CREATED_DATE,
    CASE STATUS
        WHEN 'SALE' THEN '販売中'
        WHEN 'RESERVED' THEN '予約中'
        WHEN 'DONE' THEN '取引完了'
    END AS CURRENT_STATUS,
    DATEDIFF(NOW(), CREATED_DATE) AS DAYS_SINCE_POSTED,
    CASE
        WHEN STATUS = 'DONE' AND DATEDIFF(NOW(), CREATED_DATE) <= 1 THEN '即決'
        WHEN STATUS = 'DONE' AND DATEDIFF(NOW(), CREATED_DATE) <= 7 THEN '1週間以内'
        WHEN STATUS = 'SALE' AND DATEDIFF(NOW(), CREATED_DATE) > 30 THEN '長期在庫'
        ELSE '通常'
    END AS SALES_SPEED
FROM USED_GOODS_BOARD
ORDER BY CREATED_DATE DESC;
```

### 複数条件でのステータス判定

```sql
SELECT
    BOARD_ID,
    TITLE,
    PRICE,
    VIEWS,
    STATUS,
    CASE
        WHEN STATUS = 'DONE' THEN '✓ 取引完了'
        WHEN STATUS = 'RESERVED' AND VIEWS >= 200 THEN '🔥 予約中（人気）'
        WHEN STATUS = 'RESERVED' THEN '📌 予約中'
        WHEN STATUS = 'SALE' AND PRICE >= 50000 THEN '💰 販売中（高額商品）'
        WHEN STATUS = 'SALE' AND VIEWS >= 300 THEN '👀 販売中（注目）'
        WHEN STATUS = 'SALE' THEN '📦 販売中'
        ELSE '❓ 不明'
    END AS DETAILED_STATUS
FROM USED_GOODS_BOARD
WHERE CREATED_DATE = '2022-10-05'
ORDER BY BOARD_ID DESC;
```

---

**作成日**: 2025-10-08
**難易度**: ⭐ 基本
**カテゴリ**: CASE式, 日付検索, ORDER BY DESC, ステータス変換
