# 再購入商品照会

## 📖 問題文（日本語訳）

以下はある衣類ショッピングモールのオンライン商品販売情報を含む ONLINE_SALE テーブルです。

ONLINE_SALE テーブルから、同じ会員が同じ商品を再購入したデータを求め、再購入した会員 ID と再購入した商品 ID を出力する SQL 文を作成してください。

結果は会員 ID を基準に昇順ソートし、会員 ID が同じ場合は商品 ID を基準に降順ソートしてください。

## 📊 テーブル構造

### ONLINE_SALE テーブル

ONLINE_SALE_ID、USER_ID、PRODUCT_ID、SALES_AMOUNT、SALES_DATE は、それぞれオンライン商品販売 ID、会員 ID、商品 ID、販売量、販売日を表します。

同一の日付、会員 ID、商品 ID の組み合わせに対しては、一つの販売データのみ存在します。

| Column name    | Type    | Nullable |
| -------------- | ------- | -------- |
| ONLINE_SALE_ID | INTEGER | FALSE    |
| USER_ID        | INTEGER | FALSE    |
| PRODUCT_ID     | INTEGER | FALSE    |
| SALES_AMOUNT   | INTEGER | FALSE    |
| SALES_DATE     | DATE    | FALSE    |

**サンプルデータ:**

| ONLINE_SALE_ID | USER_ID | PRODUCT_ID | SALES_AMOUNT | SALES_DATE |
| -------------- | ------- | ---------- | ------------ | ---------- |
| 1              | 1       | 3          | 2            | 2022-02-25 |
| 2              | 1       | 4          | 1            | 2022-03-01 |
| 4              | 2       | 4          | 2            | 2022-03-12 |
| 3              | 1       | 3          | 3            | 2022-03-31 |
| 5              | 3       | 5          | 1            | 2022-04-03 |
| 6              | 2       | 4          | 1            | 2022-04-06 |
| 7              | 1       | 4          | 2            | 2022-05-11 |

## 🎯 期待される出力

| USER_ID | PRODUCT_ID |
| ------- | ---------- |
| 1       | 4          |
| 1       | 3          |
| 2       | 4          |

## 💡 解答

```sql
SELECT
    USER_ID,
    PRODUCT_ID
FROM ONLINE_SALE
GROUP BY USER_ID, PRODUCT_ID
HAVING COUNT(*) > 1
ORDER BY USER_ID ASC, PRODUCT_ID DESC;
```

## 📝 解説

### アプローチ

1. USER_ID と PRODUCT_ID でグループ化してデータを集約
2. HAVING 句で購入回数が 2 回以上（COUNT(\*) > 1）のデータをフィルタリング
3. 会員 ID 昇順、商品 ID 降順でソート

### 解答の流れ

**サンプルデータの分析：**

- USER_ID = 1、PRODUCT_ID = 3：2 回購入（2/25、3/31）→ 再購入
- USER_ID = 1、PRODUCT_ID = 4：2 回購入（3/1、5/11）→ 再購入
- USER_ID = 2、PRODUCT_ID = 4：2 回購入（3/12、4/6）→ 再購入
- USER_ID = 3、PRODUCT_ID = 5：1 回購入 → 除外

**ソート結果：**

1. USER_ID 昇順：1 → 1 → 2
2. 同じ USER_ID 内で PRODUCT_ID 降順：4 → 3

最終結果：(1, 4)、(1, 3)、(2, 4)

### 学習ポイント

- **GROUP BY**: 複数カラムでグループ化して集計単位を定義
- **HAVING**: GROUP BY 後の集計結果に対する条件指定（WHERE は使用不可）
- **COUNT(\*)**: グループ内のレコード数をカウント
- **複雑なソート**: ORDER BY で複数カラム、異なる順序（ASC/DESC）を指定

### WHERE と HAVING の違い

- **WHERE**: グループ化**前**の行をフィルタリング
- **HAVING**: グループ化**後**の集計結果をフィルタリング

この問題では購入回数（COUNT）でフィルタリングするため、HAVING を使用します。

## 🔑 キーワード

- GROUP BY（複数カラム）
- HAVING
- COUNT(\*)
- ORDER BY（複数カラム、昇順・降順混在）
- 集計関数
